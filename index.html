<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DQ-like RPG Mobile</title>
    <style>
        body {
            background-color: #202020;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: "Courier New", monospace;
            overflow: hidden; /* スクロール防止 */
            touch-action: none; /* スマホでのピンチズーム等を無効化 */
        }

        /* ゲーム画面のコンテナ */
        #game-container {
            position: relative;
            border: 2px solid #fff;
            margin-bottom: 20px;
            max-width: 95vw; /* スマホ幅に収める */
        }

        canvas {
            display: block;
            background-color: #000;
            width: 100%; /* コンテナに合わせてリサイズ */
            height: auto;
            image-rendering: pixelated; /* ドット絵をくっきりさせる */
        }

        /* 会話ウィンドウ */
        #message-box {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            height: 80px;
            background: #000;
            border: 2px solid #fff;
            border-radius: 4px;
            padding: 8px;
            display: none;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 0 0 2px #000 inset;
            z-index: 10;
        }

        /* --- 仮想コントローラーのスタイル --- */
        #controller {
            display: flex;
            justify-content: space-between;
            width: 320px;
            max-width: 90vw;
            padding-bottom: 20px;
        }

        /* 十字キーエリア */
        .d-pad {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .d-btn {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #444;
            border: 1px solid #666;
            border-radius: 4px;
            touch-action: none; /* タッチ時のブラウザ標準動作無効化 */
            user-select: none;  /* 選択不可 */
        }
        .d-btn:active { background: #666; } /* タップ時の色変化 */

        .btn-up    { top: 0; left: 40px; }
        .btn-down  { bottom: 0; left: 40px; }
        .btn-left  { top: 40px; left: 0; }
        .btn-right { top: 40px; right: 0; }

        /* アクションボタンエリア */
        .action-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
        }
        .btn-a {
            width: 60px;
            height: 60px;
            background: #b22222; /* 赤っぽい色 */
            border: 2px solid #ff6347;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: none;
            user-select: none;
        }
        .btn-a:active { background: #ff6347; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="480" height="480"></canvas>
    <div id="message-box"></div>
</div>

<div id="controller">
    <div class="d-pad">
        <div class="d-btn btn-up"    data-key="ArrowUp"></div>
        <div class="d-btn btn-left"  data-key="ArrowLeft"></div>
        <div class="d-btn btn-right" data-key="ArrowRight"></div>
        <div class="d-btn btn-down"  data-key="ArrowDown"></div>
    </div>
    <div class="action-area">
        <div class="btn-a" data-key="Space">A</div>
    </div>
</div>

<script>
// --- 設定 ---
const TILE_SIZE = 32;
const ROWS = 15;
const COLS = 15;

const mapData = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,1,0,0,0,0,0,0,1],
    [1,0,0,1,1,1,0,0,0,0,1,0,0,0,1],
    [1,0,0,1,2,1,0,0,0,0,1,0,0,0,1],
    [1,0,0,1,2,1,0,0,0,0,1,0,0,0,1],
    [1,0,0,1,1,1,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,1,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,1,0,1,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const messageBox = document.getElementById('message-box');

let gameState = 'PLAYING'; 

const player = {
    x: 2, y: 2, direction: 'down', color: '#FFD700'
};

const npcs = [
    { x: 7, y: 5, color: '#FF69B4', message: "こんにちは！<br>スマホでも うごくよ。", name: "村人A" },
    { x: 10, y: 10, color: '#00FFFF', message: "下のボタンで<br>操作できるんだ。", name: "兵士" }
];

// --- 入力処理の共通化 ---

// 方向入力の処理
function inputDirection(dir) {
    if (gameState !== 'PLAYING') return;

    let nextX = player.x;
    let nextY = player.y;

    if (dir === 'ArrowUp')    { nextY--; player.direction = 'up'; }
    if (dir === 'ArrowDown')  { nextY++; player.direction = 'down'; }
    if (dir === 'ArrowLeft')  { nextX--; player.direction = 'left'; }
    if (dir === 'ArrowRight') { nextX++; player.direction = 'right'; }

    if (isWalkable(nextX, nextY)) {
        player.x = nextX;
        player.y = nextY;
    }
    draw();
}

// 決定/会話ボタンの処理
function inputAction() {
    if (gameState === 'PLAYING') {
        checkInteraction();
    } else if (gameState === 'DIALOGUE') {
        // 会話を閉じる
        gameState = 'PLAYING';
        messageBox.style.display = 'none';
    }
}

// --- イベントリスナー設定 ---

// 1. キーボード入力 (PC用)
document.addEventListener('keydown', (e) => {
    if (e.key.startsWith('Arrow')) {
        e.preventDefault(); // スクロール防止
        inputDirection(e.key);
    } else if (e.key === ' ' || e.key === 'Enter' || e.key === 'z') {
        inputAction();
    }
});

// 2. タッチ入力 (スマホ用)
// すべてのコントローラーボタンを取得
const buttons = document.querySelectorAll('.d-btn, .btn-a');

buttons.forEach(btn => {
    // タッチ開始時、およびマウスダウン時に反応させる
    const handleInput = (e) => {
        e.preventDefault(); // ブラウザ標準の拡大やスクロールを防ぐ
        const key = btn.getAttribute('data-key');
        
        if (key === 'Space') {
            inputAction();
        } else {
            inputDirection(key);
        }
    };

    btn.addEventListener('touchstart', handleInput, { passive: false });
    btn.addEventListener('mousedown', handleInput); // PCでのクリック確認用
});


// --- ロジック部分 (前回と同じ) ---

function isWalkable(x, y) {
    if (x < 0 || x >= COLS || y < 0 || y >= ROWS) return false;
    if (mapData[y][x] !== 0) return false;
    for (const npc of npcs) {
        if (npc.x === x && npc.y === y) return false;
    }
    return true;
}

function checkInteraction() {
    let targetX = player.x;
    let targetY = player.y;
    if (player.direction === 'up') targetY--;
    if (player.direction === 'down') targetY++;
    if (player.direction === 'left') targetX--;
    if (player.direction === 'right') targetX++;

    const targetNPC = npcs.find(n => n.x === targetX && n.y === targetY);
    if (targetNPC) {
        showMessage(targetNPC.name + ":<br>" + targetNPC.message);
    }
}

function showMessage(text) {
    gameState = 'DIALOGUE';
    messageBox.innerHTML = text;
    messageBox.style.display = 'block';
}

function draw() {
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    for (let y = 0; y < ROWS; y++) {
        for (let x = 0; x < COLS; x++) {
            const tile = mapData[y][x];
            let color = '#228B22'; 
            if (tile === 1) color = '#808080';
            if (tile === 2) color = '#1E90FF';
            
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
    }

    for (const npc of npcs) {
        ctx.fillStyle = npc.color;
        ctx.fillRect(npc.x * TILE_SIZE + 4, npc.y * TILE_SIZE + 4, TILE_SIZE - 8, TILE_SIZE - 8);
    }

    ctx.fillStyle = player.color;
    ctx.fillRect(player.x * TILE_SIZE + 4, player.y * TILE_SIZE + 4, TILE_SIZE - 8, TILE_SIZE - 8);
    
    ctx.fillStyle = 'black';
    let eyeX = player.x * TILE_SIZE + 12;
    let eyeY = player.y * TILE_SIZE + 12;
    if (player.direction === 'up') eyeY -= 6;
    if (player.direction === 'down') eyeY += 6;
    if (player.direction === 'left') eyeX -= 6;
    if (player.direction === 'right') eyeX += 6;
    ctx.fillRect(eyeX, eyeY, 8, 8);
}

draw();

</script>
</body>
</html>
